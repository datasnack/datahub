{% comment %}
SPDX-FileCopyrightText: 2025 Jonathan Str√∂bele <mail@jonathanstroebele.de>

SPDX-License-Identifier: AGPL-3.0-only
{% endcomment %}

{% load i18n %}

<div class="modal" id="modal_api_{{ datalayer.key }}" tabindex="-1" aria-labelledby="modal_api_{{ datalayer.key }}_title" aria-hidden="true">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<div class="modal-header">
				<h1 class="modal-title fs-5" id="modal_api_{{ datalayer.key }}_title">{% translate "Data Layer API" %}</h1>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% translate "Close" %}"></button>
			</div>
			<div class="modal-body">

				<p>
					{% url 'api-1.0.0:openapi-view' as url %}
					{% blocktranslate with open_api_url=url %}
						The Data Layers data can be accessed via an API. Below you see minimal code snippets to query the data. For more information regarding the API please look at the <a href="{{ open_api_url }}">OpenAPI documentation</a>.
					{% endblocktranslate %}
				</p>

				<p>
					{% url 'app:settings' as url %}
					{% blocktranslate with settings_url=url %}
						You can generate the required API token on <a href="{{ settings_url }}">your settings page</a>.
					{% endblocktranslate %}
				</p>

				<div class="card">
					<div class="card-header">

						<ul class="nav nav-tabs card-header-tabs" role="tablist">
							<li class="nav-item" role="presentation">
								<button class="nav-link active" id="home-tab" data-bs-toggle="tab" data-bs-target="#api-python-pane" type="button" role="tab" aria-controls="home-tab-pane" aria-selected="true">Python</button>
							</li>
							<li class="nav-item" role="presentation">
								<button class="nav-link" id="profile-tab" data-bs-toggle="tab" data-bs-target="#api-r-pane" type="button" role="tab" aria-controls="profile-tab-pane" aria-selected="false">R</button>
							</li>
						</ul>


					</div>
					<div class="card-body">


						<div class="tab-content">
							<div class="tab-pane show active" id="api-python-pane" role="tabpanel" aria-labelledby="home-tab" tabindex="0">

								<pre class="mb-0"><code class="language-python">import requests
from urllib.parse import urlencode

import pandas as pd
import matplotlib.pyplot as plt

# set host, like http://localhost:8000, to where your Data Hub is running
DH_HOST = ""
# Your personal API authentication token
# ATTENTION: tokens should not be included in production code!
# I.e, use a environment variable to store the token and set it like this:
# DH_TOKEN = os.environ["DH_TOKEN"]
DH_TOKEN = ""


def dh_data(query: dict) -> pd.DataFrame:
    response = requests.get(
        f"{DH_HOST}/api/datalayers/data?{urlencode(query)}", headers={"X-API-Key": DH_TOKEN}
    )
    if response.status_code == 200:
        d = response.json()
    else:
        raise Exception(f"Request failed ({response.status_code}): {response.text}")

    df = pd.DataFrame(d["data"])
    df[d["temporal_column"]] = pd.to_datetime(df[d["temporal_column"]], format="ISO8601")

    return df

{{ datalayer.key }}_df = dh_data({
    'datalayer_key': '{{ datalayer.key }}',

    # Optional filters to narrow down the returned data:
    #'shape_id': '',
    #'shape_type': '',
    #'start_date': '',
    #'end_date': '',
})</code></pre>
							</div>

							<div class="tab-pane" id="api-r-pane" role="tabpanel" aria-labelledby="profile-tab" tabindex="0">

<pre class="mb-0"><code class="language-r"># ===== LOAD LIBRARIES =====
library(httr)
library(jsonlite)

# ===== CONFIGURATION =====
# set host, like http://localhost:8000, to where your Data Hub is running
DH_HOST <- ""

# Your personal API authentication token
# ATTENTION: tokens should not be added to production code!
# I.e, use a .Renviron file to store the token and set it like this:
# DH_TOKEN <- Sys.getenv("DH_TOKEN")
DH_TOKEN <- ""

# ===== MAIN FUNCTION =====
dh_data <- function(query) {
  url <- paste0(DH_HOST, "/api/datalayers/data")
  response <- GET(
    url,
    query = query,
    add_headers("X-API-Key" = DH_TOKEN)
  )

  # Check if the request was successful (status code 200)
  if (status_code(response) == 200) {
    d <- fromJSON(content(response, "text", flatten = TRUE, encoding = "UTF-8"))
  } else {
    stop(sprintf("Request failed (%d): %s",
                 status_code(response),
                 content(response, as = "text")))
  }

  df <- as.data.frame(d$data)

  # Convert the time column to proper date type
  temporal_column <- d$temporal_column
  temporal_format <- d$temporal_format

  # R would fill in missing date parts with the current date.
  # as.Date("2020",format="%Y") -> 2020-<current month>-<current day> and not 2020-01-01
  if (temporal_column == "year") {
    df[[temporal_column]] <- as.Date(paste0(as.character(df[[temporal_column]]), "-01-01"))
    temporal_format <- "%Y-%m-%d"
  }

  df[[temporal_column]] <- as.Date(as.character(df[[temporal_column]]), format = temporal_format)

  return(df)
}


# ===== EXAMPLE USAGE =====
{{ datalayer.key }}_df <- dh_data(list(
  datalayer_key = "{{ datalayer.key }}"
  # Optional filters:
  # shape_id = "",
  # shape_type = "",
  # start_date = "",
  # end_date = ""
))
</code></pre>


							</div>
						</div>


					</div>
				</div>





			</div>
		</div>
	</div>
</div>
