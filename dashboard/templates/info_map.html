{% extends "base.html" %}
{% load humanize %}
{% load static %}

{% block content %}
    <link rel="stylesheet" type="text/css" href="{% static 'info_map.css' %}">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

    <h1>Information Density Map</h1>

	<div class="mt-3">
		<label for="type-dropdown" class="form-label fw-bold">Select Shape Type:</label>
		<select id="type-dropdown" class="form-select">
			<option value="">Select Type</option>
			{% for type in types %}
				<option value="{{ type.id }}">{{ type }}</option>
			{% endfor %}
		</select>
	</div>

	<label class="form-label fw-bold mt-3">Select Layers:</label>
    <div id="datalayer-controls" class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
		<div class="btn-group" role="group">
			<button id="select-all-btn" type="button" class="btn btn-primary btn-sm">Select All</button>
			<button id="clear-all-btn" type="button" class="btn btn-secondary btn-sm">Clear All</button>
		</div>
		<hr>
		<div id="datalayer-checkbox">
			{% for datalayer in datalayers %}
				<div class="form-check">
				  <input class="form-check-input" type="checkbox" id="datalayer-{{ datalayer.key }}" data-datalayer="{{ datalayer.key }}">
				  <label class="form-check-label" for="datalayer-{{ datalayer.key }}">
					{{ datalayer.name }}
				  </label>
				</div>
			{% endfor %}
		</div>
	</div>

	<button id="load-button" type="button" class="m-3 btn btn-primary">Load</button>

	<div id="map" style="height: 600px; width: 100%; margin-top: 20px;">
		<div id="loading-message">
			<div class="loader"></div>
{#			<div class="d-flex justify-content-center">#}
{#				<div class="spinner-border" role="status">#}
{#					<span class="visually-hidden">Loading...</span>#}
{#				</div>#}
{#			</div>#}
		</div>
		<div id="legend-popup" class="border rounded p-3">
			<h5>Customize Legend</h5>
			<div>
				<label for="preset-select" class="form-label">Choose Preset:</label>
				<select id="preset-select" class="form-control">

				</select>
			</div>

			<button id="apply-legend-btn" class="btn btn-primary mt-2">Apply</button>
			<button id="close-legend-btn" class="btn btn-secondary mt-2">Close</button>
		</div>
	</div>


	<div class="border rounded m-3 p-2 h-auto">
		<div id="year-slider" class="m-5"></div>
		<span id="year-slider-value"></span>
	</div>

	<div class="border rounded m-3 p-3">
		<h4>Information Ranking</h4>
		<ol id="ranking-list" class="list-group list-group-numbered"></ol>
	</div>

    <script>
        let map;
		let layerGroup = L.layerGroup();

		$(document).ready(function() {
			$('#type-dropdown').prop('selectedIndex', 0);
			$('.form-check-input').prop('checked', false);
			$('#loading-message').hide();
			if (!map) {
				map = L.map('map').setView(
					[parseFloat("{{ datahub_center_y }}"), parseFloat("{{ datahub_center_x }}")],
					parseInt("{{ datahub_center_zoom }}")
				);

				L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
					attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
				}).addTo(map);

				layerGroup.addTo(map);

				addLegend();
			}
			$('#select-all-btn').click(function () {
				$('.form-check-input').prop('checked', true);
			});

			$('#clear-all-btn').click(function () {
				$('.form-check-input').prop('checked', false);
			});

			initializeSlider({{ min_year }}, {{ max_year }});
			populateLegendSelect();
		});

		function initializeSlider(minYear, maxYear) {
			const slider = $('#year-slider')[0];
			if(slider && slider.noUiSlider){
				slider.noUiSlider.destroy();
			}
			noUiSlider.create(slider, {
				start: minYear,
				step: 1,
				range: {
					'min': minYear,
					'max': maxYear
				},
				tooltips: {
					to: function(value) {
						return value.toFixed(0);
					},
					from: function(value) {
						return Number(value);
					}
				},
				pips: {
					mode: 'values',
					values: [minYear, maxYear],
					density: 10
				}
			});

			slider.noUiSlider.on('change', updateMap);
		}

		function addLegend() {
			const legend = L.control({ position: 'bottomright' });

			legend.onAdd = function (map) {
				const div = L.DomUtil.create('div', 'info legend');
				div.innerHTML = `
					<button id="customize-legend-btn" class="btn btn-sm btn-primary" style="z-index: 500">Customize Legend</button>
					<div class="legend-bar p-2"></div>
					<div class="legend-labels">
						<span id="min-label"></span>
						<span id="max-label"></span>
					</div>
				`;
				return div;
			};

			legend.addTo(map);

			$('#customize-legend-btn').on('click', function () {
				$('#legend-popup').toggle();
			});

			$('#close-legend-btn').on('click', function () {
				$('#legend-popup').css('display', 'none');
			});
		}

		$('#load-button').on('click', updateMap);

		function updateMap() {
			$('#loading-message').show();
			const type = $('#type-dropdown').val();
			const year = parseInt($('#year-slider')[0].noUiSlider.get());
			const selectedLayers = [];
            $('.form-check-input:checked').each(function() {
				selectedLayers.push($(this).data('datalayer'));
			});

			if (year && selectedLayers.length > 0 && type) {
				setTimeout(() => {
					$.ajax({
						url: "{% url 'get_dl_count_for_year_shapes' %}",
						data: { 'type_id': type, 'year': year, 'data_layers': selectedLayers.join(',') },
						success: function (response) {
							layerGroup.clearLayers();

							const dlCounts = response.shape_dlcount_dict;
							const availableDlDict = response.shape_dl_dict;
							const missingDlDict = response.shape_missing_dl_dict;
							const geometries = response.geometries;
							const names = response.names;

							updateLegend(0, selectedLayers.length);

							const shapeData = [];
							for (const shapeId in geometries) {
								const availableDls = availableDlDict[shapeId] || 'No available data layer';
								const missingDls = missingDlDict[shapeId] || 'No missing data layer';
								const count = dlCounts[shapeId] || 0;
								const name = names[shapeId] || 'Unknown';
								shapeData.push({ id: shapeId, name, count, availableDls, missingDls });

								let geometry;

								if (typeof geometries[shapeId] === 'string') {
									geometry = JSON.parse(geometries[shapeId]);
								} else {
									geometry = geometries[shapeId];
								}

								const color = getColor(count, 0, selectedLayers.length);

								const geoJsonFeature = {
									type: 'Feature',
									geometry: geometry,
									properties: { id: shapeId, name, count}
								};

								const geoJsonLayer = L.geoJSON(geoJsonFeature, {
									style: () => ({
										fillColor: color,
										weight: 2,
										opacity: 1,
										color: 'black',
										fillOpacity: 1
									}),
									onEachFeature: (feature, layer) => {
										layer.bindPopup(`<b>${feature.properties.name}</b>
										<br>Available Data Layers: ${feature.properties.count}`)
									}
								});

								geoJsonLayer.addTo(layerGroup);
							}

							shapeData.sort((a, b) => b.count - a.count);

							const rankingList = $('#ranking-list');
							rankingList.empty();

							shapeData.forEach((shape, index) => {
								let availableDl;
								if (Array.isArray(shape.availableDls)) {
									availableDl = shape.availableDls.map(dl => `<li class="list-group-item fw-light">${dl}</li>`).join('');
								} else {
									availableDl = `<li class="list-group-item fw-light">${shape.availableDls}</li>`;
								}
								let missingDl;
								if (Array.isArray(shape.missingDls)) {
									missingDl = shape.missingDls.map(dl => `<li class="list-group-item fw-light">${dl}</li>`).join('');
								} else {
									missingDl = `<li class="list-group-item fw-light">${shape.missingDls}</li>`;
								}

								rankingList.append(`
									<li class="list-group-item">
										<b class="shape-name" data-index="${index}" style="cursor: pointer;">
											${shape.name}
											<span class="badge text-bg-primary rounded-pill">${shape.count}</span>
										</b>
										<div class="details-dls container text-center m-4" style="display: none;">
											<div class="row">
												<div class="col">
													<label class="form-label fw-bold">Available Data Layers</label>
													<ul class="available-dls list-group list-group-flush">
														${availableDl}
													</ul>
												</div>
												<div class="col">
													<label class="form-label fw-bold">Missing Data Layers</label>
													<ul class="missing-dls list-group list-group-flush">
														${missingDl}
													</ul>
												</div>
											</div>
										</div>
									</li>
								`);
							});

							$('.shape-name').on('click', function () {
								$(this).next('.details-dls').toggle();
							});

							$('#loading-message').hide();

						},
						error: function (xhr, status, error) {
							console.error('Error fetching data layer count:', error);
							$('#loading-message').hide();
						}
					});
				}, 300);
			} else {
				alert('Missing input. Please make sure that the type and data layers are selected.');
				$('#loading-message').hide();
			}
		}

		const presets = {{ presets|safe }};

		let currentPreset = presets[Object.keys(presets)[0]].colors;

		$('#apply-legend-btn').on('click', function () {
			const selectedPreset = $('#preset-select').val();
			if (presets[selectedPreset]) {
				currentPreset = presets[selectedPreset].colors;
				applyPreset();
				$('#legend-popup').css('display', 'none');
			} else {
				alert('Invalid preset selected.');
			}
		});

		function populateLegendSelect() {
			const presetSelect = $('#preset-select');
			Object.keys(presets).forEach(presetKey => {
				const option = $('<option>')
					.attr('value', presetKey)
					.text(presets[presetKey].name);
				presetSelect.append(option);
			});
		}

		function updateLegend(minValue, maxValue) {
			$('#min-label').text(Math.round(minValue));
			$('#max-label').text(Math.round(maxValue));
			updateLegendBar()
		}

		function updateLegendBar() {
			const legendBar = $('.legend-bar');
			legendBar.empty();
			const row = $('<div>').addClass('d-flex w-100 flex-row');
			currentPreset.forEach(color => {
				const col = $('<div>')
					.addClass('flex-fill')
					.css({
						background: color,
						height: '10px',
					});
				row.append(col);
			});
			legendBar.append(row);
		}

		function applyPreset() {
			updateLegendBar()
			layerGroup.eachLayer(layer => {
				if (layer._layers) {
					Object.values(layer._layers).forEach(subLayer => {
						if (subLayer.feature && subLayer.feature.properties) {
							const count = subLayer.feature.properties.count;
							const color = getColor(count, 0, $('#datalayer-checkbox .form-check-input:checked').length);
							subLayer.setStyle({
								fillColor: color
							});
						} else {
							console.warn('Sub-layer lacks feature or properties:', subLayer);
						}
					});
				}
			});
		}

		function getColor(value, minValue, maxValue) {
			const norm_val = (value - minValue) / (maxValue - minValue);
			if (norm_val > 0.8) return currentPreset[4];
			if (norm_val > 0.6) return currentPreset[3];
			if (norm_val > 0.4) return currentPreset[2];
			if (norm_val > 0.2) return currentPreset[1];
			return currentPreset[0];
		}
    </script>
{% endblock %}
